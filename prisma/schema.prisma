// prisma/schema.prisma - SCHEMA COMPLETO
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// USUARIOS
model Usuario {
  id                 String             @id @default(uuid())
  nombre             String
  email              String             @unique
  password           String
  tipo_usuario       String
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  telefono           String? // ✅ AGREGAR ESTA LÍNEA (opcional)
  foto_perfil_url    String?
  bloqueado          Boolean            @default(false) // Para bloquear usuarios
  preferencias_notificacion Json?   @map("preferencias_notificacion") // Preferencias de notificación
  
  // Mercado Pago Connect
  mp_access_token     String?
  mp_public_key       String?
  mp_refresh_token    String?
  mp_user_id          String?
  mp_expires_in       Int?
  eventosCreados      Evento[]           @relation("OrganizadorEventos")
  reservas            Reserva[]          @relation("AsistenteReservas")
  productosServicios  ProductoServicio[] @relation("ProveedorServicios")
  reportesCreados     Reporte[]          @relation("ReportesCreados")
  reportesRecibidos   Reporte[]          @relation("UsuarioReportado")
  reportesGestionados Reporte[]          @relation("ReportesGestionados")
  auditorias          Auditoria[]
  notificaciones      Notificacion[]
  favoritos           Favorito[]         @relation("UsuarioFavoritos")
  eventoStaffId       String? // ID del evento asignado (Solo para Staff)
  eventoStaff         Evento?            @relation("StaffEvento", fields: [eventoStaffId], references: [id])
  
  // Chatbot
  conversacionesIniciadas Conversacion[] @relation("ConversacionUsuario")
  conversacionesAtendidas Conversacion[] @relation("ConversacionAdmin")
  mensajesEnviados        Mensaje[]      @relation("MensajesEnviados")

  @@map("usuarios")
}

// CATEGORÍAS
model CategoriaEvento {
  id          String   @id @default(uuid())
  nombre      String   @unique
  descripcion String?
  createdAt   DateTime @default(now()) @map("created_at")

  eventos Evento[]

  @@map("categorias_evento")
}

// EVENTOS
model Evento {
  id             String   @id @default(uuid())
  nombre         String
  descripcion    String   @db.Text
  fecha_inicio   DateTime
  fecha_fin      DateTime
  ubicacion      String
  aforo_max      Int
  categoria_id   String
  organizador_id String
  estado         String   @default("programado")
  imagen_url     String? // <--- AGREGA ESTA LÍNEA
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  bloqueado      Boolean  @default(false) // Para bloquear eventos
  categoria                CategoriaEvento          @relation(fields: [categoria_id], references: [id])
  organizador              Usuario                  @relation("OrganizadorEventos", fields: [organizador_id], references: [id])
  reservas                 Reserva[]
  tiposEntrada             TipoEntrada[] // ← AGREGA ESTA LÍNEA
  productosServiciosEvento EventoProductoServicio[]
  reportes                 Reporte[]
  favoritos                Favorito[]               @relation("EventoFavoritos")
  staff                    Usuario[]                @relation("StaffEvento") // ← RELACIÓN STAFF

  @@map("eventos")
}

// RESERVAS
model Reserva {
  id               String   @id @default(uuid())
  evento_id        String
  asistente_id     String
  tipo_entrada_id  String? // Relación con TipoEntrada
  cantidad_boletos Int
  precio_total     Decimal  @db.Decimal(10, 2)
  metodo_pago      String
  estado_reserva   String   @default("confirmada")
  fecha_reserva    DateTime @default(now())
  qr_data          String?  @db.Text
  qr_hash          String?
  numero_orden     String? // AGREGA ESTE CAMPO para el número de orden
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  evento             Evento             @relation(fields: [evento_id], references: [id])
  tipoEntrada        TipoEntrada?       @relation(fields: [tipo_entrada_id], references: [id])
  asistente          Usuario            @relation("AsistenteReservas", fields: [asistente_id], references: [id])
  credencialesAcceso CredencialAcceso[]
  pagos              Pago[]
  reembolsos         Reembolso[]

  @@map("reservas")
}

// CREDENCIALES DE ACCESO (QR)
model CredencialAcceso {
  id                String    @id @default(uuid())
  reserva_id        String
  codigo_qr         String    @unique
  estado_validacion String    @default("pendiente")
  fecha_validacion  DateTime?
  tipo_entrada_id   String? // Este campo debe existir
  createdAt         DateTime  @default(now()) @map("created_at")

  reserva     Reserva      @relation(fields: [reserva_id], references: [id])
  tipoEntrada TipoEntrada? @relation(fields: [tipo_entrada_id], references: [id]) // Nombre del campo es tipoEntrada

  @@map("credenciales_acceso")
}

// PAGOS
model Pago {
  id                 String   @id @default(uuid())
  reserva_id         String
  monto              Decimal  @db.Decimal(10, 2)
  metodo_pago        String
  estado_transaccion String   @default("pendiente")
  referencia_externa String?
  fecha_pago         DateTime @default(now())
  createdAt          DateTime @default(now()) @map("created_at")

  reserva Reserva @relation(fields: [reserva_id], references: [id])

  @@map("pagos")
}

// REEMBOLSOS
model Reembolso {
  id               String    @id @default(uuid())
  reserva_id       String
  monto_reembolso  Decimal   @db.Decimal(10, 2)
  motivo           String?   @db.Text
  estado_reembolso String    @default("solicitado")
  fecha_solicitud  DateTime  @default(now())
  fecha_procesado  DateTime?
  createdAt        DateTime  @default(now()) @map("created_at")

  reserva Reserva @relation(fields: [reserva_id], references: [id])

  @@map("reembolsos")
}

// PRODUCTOS Y SERVICIOS (Proveedores)
model ProductoServicio {
  id             String   @id @default(uuid())
  proveedor_id   String
  nombre         String
  descripcion    String   @db.Text
  categoria      String
  precio_base    Decimal  @db.Decimal(10, 2)
  disponibilidad Boolean  @default(true)
  bloqueado      Boolean  @default(false) // Para bloquear servicios
  imagen_url     String? // URL de la imagen del servicio
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  proveedor Usuario                  @relation("ProveedorServicios", fields: [proveedor_id], references: [id])
  eventos   EventoProductoServicio[]
  reportes  Reporte[]

  @@map("productos_servicios")
}

// RELACIÓN EVENTOS - PRODUCTOS/SERVICIOS
model EventoProductoServicio {
  id                   String   @id @default(uuid())
  evento_id            String
  producto_servicio_id String
  cantidad             Int      @default(1)
  precio_acordado      Decimal  @db.Decimal(10, 2)
  estado_contratacion  String   @default("pendiente")
  createdAt            DateTime @default(now()) @map("created_at")

  evento           Evento           @relation(fields: [evento_id], references: [id])
  productoServicio ProductoServicio @relation(fields: [producto_servicio_id], references: [id])

  @@map("eventos_productos_servicios")
}

// NOTIFICACIONES
model Notificacion {
  id         String   @id @default(uuid())
  usuario_id String
  tipo       String
  mensaje    String   @db.Text
  leida      Boolean  @default(false)
  createdAt  DateTime @default(now()) @map("created_at")

  usuario Usuario @relation(fields: [usuario_id], references: [id])

  @@map("notificaciones")
}

// REPORTES
model Reporte {
  id           String @id @default(uuid())
  tipo_reporte String // 'evento' | 'servicio' | 'usuario' | 'bug'
  categoria    String // Specific category based on type
  descripcion  String @db.Text
  estado       String @default("pendiente") // 'pendiente' | 'en_revision' | 'resuelto' | 'rechazado'
  prioridad    String @default("media") // 'baja' | 'media' | 'alta' | 'critica'

  // Reporter
  reportante_id String
  reportante    Usuario @relation("ReportesCreados", fields: [reportante_id], references: [id])

  // Reported entities (optional, depends on tipo_reporte)
  evento_id String?
  evento    Evento? @relation(fields: [evento_id], references: [id])

  servicio_id String?
  servicio    ProductoServicio? @relation(fields: [servicio_id], references: [id])

  usuario_reportado_id String?
  usuario_reportado    Usuario? @relation("UsuarioReportado", fields: [usuario_reportado_id], references: [id])

  // Admin response
  respuesta_admin String?  @db.Text
  admin_id        String?
  admin           Usuario? @relation("ReportesGestionados", fields: [admin_id], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("reportes")
}

// AUDITORÍAS
model Auditoria {
  id          String   @id @default(uuid())
  usuario_id  String
  accion      String
  tabla       String
  registro_id String?
  detalles    String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  usuario Usuario @relation(fields: [usuario_id], references: [id])

  @@map("auditorias")
}

// TIPOS DE ENTRADA
model TipoEntrada {
  id         String   @id @default(uuid())
  evento_id  String
  nombre     String // Ej: "Degustación Premium", "General"
  precio     Decimal  @db.Decimal(10, 2)
  cantidad_total Int      @default(100) // Cantidad total de entradas de este tipo
  disponible Boolean  @default(true)
  createdAt  DateTime @default(now())

  evento             Evento             @relation(fields: [evento_id], references: [id], onDelete: Cascade)
  reservas           Reserva[]
  credencialesAcceso CredencialAcceso[]

  @@map("tipos_entrada")
}

// FAVORITOS
model Favorito {
  id         String   @id @default(uuid())
  usuario_id String
  evento_id  String
  createdAt  DateTime @default(now()) @map("created_at")

  usuario Usuario @relation("UsuarioFavoritos", fields: [usuario_id], references: [id], onDelete: Cascade)
  evento  Evento  @relation("EventoFavoritos", fields: [evento_id], references: [id], onDelete: Cascade)

  @@unique([usuario_id, evento_id])
  @@map("favoritos")
}

// CHATBOT - Conversaciones y Mensajes
model Conversacion {
  id              String    @id @default(uuid())
  usuario_id      String
  admin_id        String?
  estado          String    @default("bot") // 'bot', 'humano', 'cerrada'
  asunto          String?
  contexto        Json?     // Información del usuario: rol, eventos, etc.
  requiere_humano Boolean   @default(false)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  usuario  Usuario   @relation("ConversacionUsuario", fields: [usuario_id], references: [id], onDelete: Cascade)
  admin    Usuario?  @relation("ConversacionAdmin", fields: [admin_id], references: [id], onDelete: SetNull)
  mensajes Mensaje[]

  @@map("conversaciones")
}

model Mensaje {
  id              String       @id @default(uuid())
  conversacion_id String
  remitente_id    String
  contenido       String       @db.Text
  es_bot          Boolean      @default(false)
  leido           Boolean      @default(false)
  createdAt       DateTime     @default(now()) @map("created_at")

  conversacion Conversacion @relation(fields: [conversacion_id], references: [id], onDelete: Cascade)
  remitente    Usuario      @relation("MensajesEnviados", fields: [remitente_id], references: [id], onDelete: Cascade)

  @@map("mensajes")
}
